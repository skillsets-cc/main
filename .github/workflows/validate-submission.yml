name: Validate Submission

on:
  pull_request:
    paths:
      - 'skillsets/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Find changed skillsets
        id: changed
        run: |
          # Get list of changed directories in skillsets/
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD)
          DIRS=$(echo "$CHANGED_FILES" | grep '^skillsets/' | cut -d'/' -f1-3 | sort -u)

          if [ -z "$DIRS" ]; then
            echo "No skillset changes detected"
            echo "dirs=" >> $GITHUB_OUTPUT
          else
            echo "Changed skillsets:"
            echo "$DIRS"
            # Convert to space-separated for iteration
            DIRS_SPACED=$(echo "$DIRS" | tr '\n' ' ')
            echo "dirs=$DIRS_SPACED" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.changed.outputs.dirs != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run skillsets audit
        if: steps.changed.outputs.dirs != ''
        run: |
          EXIT_CODE=0
          for dir in ${{ steps.changed.outputs.dirs }}; do
            echo "=========================================="
            echo "Running audit on $dir"
            echo "=========================================="

            cd "$dir"
            npx skillsets@latest audit --check || EXIT_CODE=1
            cd "$GITHUB_WORKSPACE"
          done

          exit $EXIT_CODE

      - name: Verify author matches GitHub handle
        if: steps.changed.outputs.dirs != ''
        run: |
          EXIT_CODE=0
          for dir in ${{ steps.changed.outputs.dirs }}; do
            echo "=========================================="
            echo "Verifying author in $dir"
            echo "=========================================="

            if [ ! -f "$dir/skillset.yaml" ]; then
              echo "❌ ERROR: Missing skillset.yaml in $dir"
              EXIT_CODE=1
              continue
            fi

            # Extract namespace from path (skillsets/@namespace/skillset-name or skillsets/namespace/skillset-name)
            NAMESPACE=$(echo "$dir" | cut -d'/' -f2 | sed 's/@//')

            # Extract author handle from skillset.yaml
            AUTHOR_HANDLE=$(yq eval '.author.handle' "$dir/skillset.yaml" | sed 's/@//')

            # Get PR author
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"

            echo "Namespace: $NAMESPACE"
            echo "Author handle: $AUTHOR_HANDLE"
            echo "PR author: $PR_AUTHOR"

            # Check if this is a modification to existing skillset (skillset.yaml exists in base)
            if git cat-file -e ${{ github.event.pull_request.base.sha }}:"$dir/skillset.yaml" 2>/dev/null; then
              echo "Existing skillset - verifying author can modify"
              if [ "$AUTHOR_HANDLE" != "$PR_AUTHOR" ]; then
                echo "❌ ERROR: Only the original author (@$AUTHOR_HANDLE) can modify this skillset"
                echo "PR submitted by: @$PR_AUTHOR"
                EXIT_CODE=1
              else
                echo "✅ Author verification passed (existing skillset)"
              fi
            else
              echo "New skillset - verifying namespace and author match PR author"
              if [ "$NAMESPACE" != "$PR_AUTHOR" ]; then
                echo "❌ ERROR: Namespace (@$NAMESPACE) must match PR author (@$PR_AUTHOR) for new submissions"
                EXIT_CODE=1
              elif [ "$AUTHOR_HANDLE" != "$PR_AUTHOR" ]; then
                echo "❌ ERROR: Author handle (@$AUTHOR_HANDLE) must match PR author (@$PR_AUTHOR) for new submissions"
                EXIT_CODE=1
              else
                echo "✅ Author verification passed (new skillset)"
              fi
            fi
          done

          exit $EXIT_CODE

      - name: Verify batch ID reservation
        if: steps.changed.outputs.dirs != ''
        run: |
          EXIT_CODE=0
          for dir in ${{ steps.changed.outputs.dirs }}; do
            echo "=========================================="
            echo "Verifying reservation in $dir"
            echo "=========================================="

            if [ ! -f "$dir/skillset.yaml" ]; then
              continue
            fi

            # Skip reservation check for updates to existing skillsets
            if git cat-file -e ${{ github.event.pull_request.base.sha }}:"$dir/skillset.yaml" 2>/dev/null; then
              echo "✅ Existing skillset — reservation check skipped"
              continue
            fi

            BATCH_ID=$(yq eval '.batch_id' "$dir/skillset.yaml")
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_AUTHOR_ID="${{ github.event.pull_request.user.id }}"

            if [ "$BATCH_ID" = "null" ] || [ -z "$BATCH_ID" ]; then
              echo "::error::Missing batch_id in $dir/skillset.yaml"
              EXIT_CODE=1
              continue
            fi

            echo "Batch ID: $BATCH_ID"
            echo "PR Author: $PR_AUTHOR (ID: $PR_AUTHOR_ID)"

            # Pass both login and userId — handles GitHub username renames
            # --max-time 10 --retry 2: prevent CI hang if skillsets.cc is down
            RESPONSE=$(curl -sf --max-time 10 --retry 2 "https://skillsets.cc/api/reservations/verify?batchId=$BATCH_ID&login=$PR_AUTHOR&userId=$PR_AUTHOR_ID") || {
              echo "::warning::Reservation verification unavailable (skillsets.cc unreachable). Skipping."
              continue
            }
            VALID=$(echo "$RESPONSE" | jq -r '.valid')

            if [ "$VALID" != "true" ]; then
              REASON=$(echo "$RESPONSE" | jq -r '.reason')
              echo "::error::Reservation verification failed: $REASON"
              EXIT_CODE=1
            else
              echo "✅ Reservation verified for $BATCH_ID"
            fi
          done

          exit $EXIT_CODE

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Validation Summary"
          echo "=========================================="
          echo ""
          echo "Changed skillsets: ${{ steps.changed.outputs.dirs }}"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ All validation checks passed!"
            echo ""
            echo "Next steps:"
            echo "1. A maintainer will review your production proof"
            echo "2. Once approved, your skillset will be merged"
            echo "3. The site will automatically rebuild with your submission"
          else
            echo "❌ Some validation checks failed."
            echo ""
            echo "Please review the errors above and update your PR."
            echo "See CONTRIBUTING.md for submission guidelines."
          fi
