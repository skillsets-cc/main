# Site

## Purpose
Astro 5 SSR application running on Cloudflare Workers. Serves as the public-facing registry for skillsets.cc with static-first architecture, React islands for interactivity, and API routes backed by Cloudflare KV and Durable Objects.

## Architecture
```
site/
├── astro.config.mjs               # Astro SSR + Cloudflare adapter + React/Tailwind
├── tailwind.config.js             # Design tokens: colors, fonts, spacing, prose
├── tsconfig.json                  # Strict mode + path aliases (@/*, @components/*)
├── vitest.config.ts               # jsdom + Cloudflare Workers mocking
├── wrangler.toml                  # Worker bindings: KV, Durable Objects, secrets
├── package.json                   # Scripts: dev, build, build:index, test, typecheck
│
├── scripts/
│   └── build-index.ts             # Generates search-index.json from skillsets/ registry
│
├── public/
│   ├── search-index.json          # CDN-hosted search index (generated by build-index.ts)
│   ├── favicon.svg                # SVG favicon (Crimson Pro "S")
│   ├── favicon.ico                # ICO fallback
│   └── .assetsignore              # Excludes _worker.js and _routes.json from static assets
│
├── vitest-mocks/
│   └── cloudflare-workers.ts      # Stub DurableObject class for unit tests
│
├── docs_site/                     # Site-level documentation
│   ├── ARC_site.md                # This file
│   ├── astro.config.md
│   ├── tailwind.config.md
│   ├── tsconfig.md
│   ├── vitest.config.md
│   ├── wrangler.md
│   ├── build-index.md
│   └── worker.md
│
└── src/
    ├── worker.ts                  # Custom worker entry (Astro handler + DO exports)
    │
    ├── components/                # React islands + Astro components
    │   ├── AuthStatus.tsx         # Login/logout link with auth state
    │   ├── CopyCommand.tsx        # Install command with clipboard copy
    │   ├── DownloadCount.tsx      # Live download count display
    │   ├── GhostCard.tsx          # Ghost entry slot card (available/reserved/submitted)
    │   ├── MediaGallery.astro     # Image gallery for skillset media
    │   ├── ProofGallery.astro     # Verification proof badges (sticky bar)
    │   ├── SkillsetGrid.tsx       # Orchestrates filtering + grid + ghost entries
    │   ├── StarButton.tsx         # Interactive star toggle
    │   ├── TagFilter.tsx          # Tag-based filtering (fixed bottom bar, portal)
    │   ├── useCountdown.ts        # Countdown timer hook for reservations
    │   ├── docs_components/       # Per-file docs
    │   └── __tests__/             # Component tests
    │
    ├── lib/                       # Server-side utilities
    │   ├── auth.ts                # GitHub OAuth + PKCE + JWT sessions
    │   ├── data.ts                # Build-time search index access
    │   ├── downloads.ts           # Download count tracking + rate limiting
    │   ├── maintainer.ts          # Maintainer authorization logic
    │   ├── rate-limit.ts          # Hour-bucketed KV rate limiter
    │   ├── reservation-do.ts      # Ghost entry reservation Durable Object
    │   ├── responses.ts           # JSON response helpers
    │   ├── sanitize.ts            # XSS protection (js-xss) + URL validation
    │   ├── stars.ts               # Star/unstar with rate limiting
    │   ├── validation.ts          # Input validation (skillset ID format)
    │   ├── docs_lib/              # Per-file docs
    │   └── __tests__/             # Library tests
    │
    ├── pages/                     # File-based routing
    │   ├── index.astro            # Homepage with intro + embedded grid (prerendered)
    │   ├── about.astro            # About page (prerendered)
    │   ├── contribute.astro       # Submission guide with cohort claiming (prerendered)
    │   ├── cli.astro              # CLI reference (prerendered)
    │   ├── 404.astro              # Error page (prerendered)
    │   ├── login.ts               # OAuth initiation
    │   ├── callback.ts            # OAuth callback
    │   ├── logout.ts              # Session clearance
    │   ├── skillset/[namespace]/
    │   │   └── [name].astro       # Skillset detail (SSR)
    │   ├── api/
    │   │   ├── star.ts            # GET/POST star operations
    │   │   ├── downloads.ts       # POST download increment
    │   │   ├── me.ts              # GET authenticated user profile
    │   │   ├── reservations.ts    # GET/POST/DELETE slot reservation CRUD
    │   │   ├── stats/
    │   │   │   └── counts.ts      # GET aggregate star + download counts
    │   │   └── reservations/
    │   │       ├── config.ts      # POST config updates (maintainer)
    │   │       ├── verify.ts      # GET batch ID verification (CI)
    │   │       ├── lookup.ts      # GET user's reservation
    │   │       └── submit.ts      # POST mark slot submitted (maintainer)
    │   └── docs_pages/            # Per-file docs
    │
    ├── types/
    │   ├── index.ts               # SearchIndex, SearchIndexEntry, McpServer, McpNestedServer, SlotStatus, GhostSlot, ReservationState
    │   ├── docs_types/            # Per-file docs
    │   └── __tests__/             # Type tests
    │
    ├── layouts/
    │   ├── BaseLayout.astro       # Global layout (sidebar nav + mobile drawer + slot)
    │   └── docs_layouts/          # Per-file docs
│
    └── styles/
        ├── global.css                 # Tailwind layers + typography + scrollbar
        └── docs_styles/               # Per-file docs
```

## Modules

| Module | Purpose | ARC Doc |
|--------|---------|---------|
| **components** | React islands + Astro components for UI (filtering, stars, ghost entries, galleries) | [ARC_components.md](../src/components/docs_components/ARC_components.md) |
| **lib** | Server-side auth, stars, downloads, reservations, data, sanitization, validation | [ARC_lib.md](../src/lib/docs_lib/ARC_lib.md) |
| **pages** | Routes: static pages, auth endpoints, star/download APIs, reservation APIs | [ARC_pages.md](../src/pages/docs_pages/ARC_pages.md) |
| **types** | TypeScript interfaces for skillsets, search index, MCP servers, reservations | [ARC_types.md](../src/types/docs_types/ARC_types.md) |
| **layouts** | Base HTML layout with sidebar navigation and mobile drawer | [ARC_layouts.md](../src/layouts/docs_layouts/ARC_layouts.md) |
| **styles** | Global CSS: Tailwind integration, typography system, scrollbar | [ARC_styles.md](../src/styles/docs_styles/ARC_styles.md) |

## Routes

### Static Pages (Prerendered)
| Route | Page | Description |
|-------|------|-------------|
| `/` | index.astro | Homepage with intro + embedded skillset grid |
| `/about` | about.astro | Problem/solution narrative |
| `/contribute` | contribute.astro | Submission guide with cohort claiming flow |
| `/cli` | cli.astro | CLI reference docs |
| `/404` | 404.astro | Error page with browse link |

### Dynamic Pages (SSR)
| Route | Page | Description |
|-------|------|-------------|
| `/skillset/[ns]/[name]` | [name].astro | Detail page with README, stars, downloads, MCP servers, media gallery |

### Auth Endpoints
| Route | Method | Description |
|-------|--------|-------------|
| `/login` | GET | Generate PKCE + state, redirect to GitHub |
| `/callback` | GET | Validate state, exchange code, create JWT |
| `/logout` | GET | Clear session cookie, redirect home |

### API Endpoints

#### Star & Download Tracking
| Route | Method | Auth | Description |
|-------|--------|------|-------------|
| `/api/star` | GET | No | Star count + user's starred status |
| `/api/star` | POST | Yes | Toggle star (rate limited: 10/min) |
| `/api/downloads` | POST | No | Increment download count (rate limited: 30/hr per IP) |
| `/api/stats/counts` | GET | No | Bulk star + download counts |
| `/api/me` | GET | Yes | Authenticated user's login |

#### Reservation System
| Route | Method | Auth | Description |
|-------|--------|------|-------------|
| `/api/reservations` | GET | No | All slot states + config |
| `/api/reservations` | POST | Yes | Reserve a slot (rate limited: 5/hr) |
| `/api/reservations` | DELETE | Yes | Release user's reservation |
| `/api/reservations/config` | POST | Maintainer | Update reservation config |
| `/api/reservations/verify` | GET | No | Verify batch ID (CI, rate limited: 30/hr per IP) |
| `/api/reservations/lookup` | GET | No | Find user's reservation (rate limited: 30/hr per IP) |
| `/api/reservations/submit` | POST | Maintainer | Mark slot as submitted |

## Data Flow

### Build Time
```
GitHub Registry (skillsets/)
  ↓
GitHub Action generates search-index.json
  ↓
Astro imports at build → embedded in static pages
  ↓
Deploy to Cloudflare Workers
```

### Homepage (Static + Islands)
```
CDN serves prerendered HTML
  ↓
SkillsetGrid hydrates (client:load)
  ↓
TagFilter (fixed bottom bar, portal) → filtered results
  ↓
Single request: fetch /api/stats/counts → all star counts → hydrate grid
  ↓
Fetch /api/reservations → ghost entry slots → render GhostCards
```

### Skillset Detail (SSR)
```
Request → /skillset/@ns/name
  ↓
Look up in search-index.json (build-time data)
  ↓
Fetch README.md from GitHub raw content API
  ↓
marked → HTML → sanitizeHtml (js-xss) + Mermaid diagram rendering
  ↓
Render with StarButton, DownloadCount, CopyCommand, ProofGallery, MediaGallery
  ↓
If mcp_servers: render MCP section (native/docker grouped, reputation, runtime caveat)
```

### Authentication
```
/login → generate state + PKCE verifier → store in KV (5-min TTL)
  ↓
Redirect to GitHub OAuth
  ↓
GitHub → /callback?code=X&state=Y
  ↓
Validate state (KV) → exchange code (with PKCE) → fetch user
  ↓
Create JWT (HMAC-SHA256, 7-day expiry) → httpOnly cookie
```

### Star Toggle
```
StarButton POST /api/star
  ↓
Verify JWT from cookie → check rate limit (KV)
  ↓
toggleStar() → read user stars + count from KV → update both
  ↓
Return { starred, count } → update UI
```

### Reservation Flow
```
User clicks "Claim" on GhostCard
  ↓
POST /api/reservations { slotId }
  ↓
Verify session → validate slotId → forward to Durable Object
  ↓
DO atomically reserves slot (slot + user index)
  ↓
Return { batchId, status: "reserved" } → optimistic UI update
  ↓
24-hour TTL → expires to available if not submitted
```

## Dependencies

### External
- `astro@5.x` — SSR framework
- `@astrojs/cloudflare` — Workers adapter
- `@astrojs/react` — React islands integration
- `@astrojs/tailwind` — Tailwind CSS
- `react@19.x` — Interactive components
- `fuse.js` — Client-side fuzzy search (in SkillsetGrid)
- `marked` — Markdown to HTML
- `xss` — HTML sanitization

### Services
- **Cloudflare Workers** — Hosting + SSR
- **Cloudflare KV** — AUTH namespace (OAuth state), DATA namespace (stars, downloads, rate limits)
- **Cloudflare Durable Objects** — RESERVATIONS namespace (atomic slot management)
- **GitHub OAuth API** — Authentication
- **GitHub Raw Content API** — README fetching for detail pages

## KV Storage Schema

### AUTH Namespace
```
oauth:{state} → { codeVerifier, returnTo }    (5-min TTL)
```

### DATA Namespace
```
stars:{skillsetId}       → "42"                (star count)
user:{userId}:stars      → ["id1", "id2"]      (user's starred IDs)
downloads:{skillsetId}   → "123"               (download count)
ratelimit:{userId}       → "7"                 (star ops count, 60s TTL)
dl-rate:{ip}             → "12"                (download ops count, 3600s TTL)
```

### RESERVATIONS Durable Object Storage
```
slot:{batchId}  → SlotData (discriminated union: reserved or submitted)
user:{userId}   → string (batch ID user has reserved)
config          → { totalGhostSlots, ttlDays, cohort }
```

## Key Patterns

- **Static-First**: `prerender: true` on all content pages; SSR only for skillset detail (runtime README fetch)
- **Islands Architecture**: Static HTML default, React hydrated with `client:load` for interactivity
- **Build-Time Index**: Search via CDN-hosted JSON (includes MCP server metadata), no runtime GitHub API for browsing
- **Portal Rendering**: TagFilter uses `createPortal` to render fixed bottom bar at document root
- **Optimistic UI**: Ghost entry reserve/cancel updates immediately, reconciles async
- **KV Retry**: Exponential backoff on 429s (100ms → 200ms → 400ms, 3 attempts)
- **PKCE + CSRF**: OAuth uses code_challenge + random state param with TTL
- **Durable Objects**: Atomic reservation state prevents race conditions on slot claiming

## Security

| Layer | Implementation |
|-------|----------------|
| **XSS** | js-xss whitelist sanitization on README HTML; `sanitizeUrl` protocol allowlist for user-supplied URLs |
| **CSRF** | Random state param with 5-min KV TTL |
| **PKCE** | SHA-256 code_challenge prevents code interception |
| **Sessions** | JWT in httpOnly/Secure/SameSite=Lax cookie (7-day expiry) |
| **Rate Limiting** | Stars: 10/min per user; Downloads: 30/hr per IP; Reservations: 5/hr per user; Verify/Lookup: 30/hr per IP |
| **Input Validation** | Skillset ID format checks prevent KV key injection |
| **Authorization** | Maintainer-only endpoints (config, submit) via allowlist |

## Design System

### Typography
- **Serif**: Crimson Pro (headings, descriptions, body text) — 18px base (scaled up from 16px to compensate for smaller x-height)
- **Mono**: JetBrains Mono at 0.95em (code, metadata, labels — scaled down to visually match serif)

### Colors
- **Background**: stone-50 (light warm gray)
- **Text**: text-ink (near-black), text-secondary, text-tertiary
- **Accent**: orange-500 (links, stars, highlights)
- **Borders**: border-ink (black), border-light
- **Status**: green-500

### Component Patterns
- No border radius (`.btn-primary` uses `rounded-none` for sharp aesthetic)
- Monospace UI elements (buttons use `font-mono`)
- Glassmorphism: `bg-white/90 backdrop-blur-sm` for TagFilter bar
- Stable scrollbar: `scrollbar-gutter: stable` prevents layout shift

## Testing
```bash
cd site && npm test          # Vitest + React Testing Library
cd site && npm run typecheck # TypeScript strict mode
cd site && npm run build     # Full build verification
```

## Configuration

| File | Purpose | Documentation |
|------|---------|---------------|
| `astro.config.mjs` | SSR output, Cloudflare adapter, React + Tailwind, DO exports | [Docs](./astro.config.md) |
| `tailwind.config.js` | Design tokens: colors, fonts, spacing, prose styling | [Docs](./tailwind.config.md) |
| `tsconfig.json` | Strict mode, React JSX, path aliases (`@/*`, `@components/*`) | [Docs](./tsconfig.md) |
| `vitest.config.ts` | jsdom environment, Cloudflare Workers mocking, path aliases | [Docs](./vitest.config.md) |
| `wrangler.toml` | Worker name, KV bindings, DO bindings, env vars, migrations | [Docs](./wrangler.md) |

## Build Pipeline

| File | Purpose | Documentation |
|------|---------|---------------|
| `scripts/build-index.ts` | Generates `search-index.json` from skillsets/ registry | [Docs](./build-index.md) |
| `src/worker.ts` | Custom worker entry (Astro handler + Durable Object exports) | [Docs](./worker.md) |

## Static Assets

| File | Purpose |
|------|---------|
| `public/search-index.json` | CDN-hosted search index consumed by site and CLI |
| `public/favicon.svg` | SVG favicon (Crimson Pro "S" letterform) |
| `public/favicon.ico` | ICO fallback for older browsers |
| `public/.assetsignore` | Excludes `_worker.js` and `_routes.json` from Cloudflare static asset serving |

## Test Infrastructure

| File | Purpose |
|------|---------|
| `vitest-mocks/cloudflare-workers.ts` | Stub `DurableObject` base class for unit testing `reservation-do.ts` |

## Related Documentation
- [Frontend Style Guide](../../.claude/resources/frontend_styleguide.md)
- [Workers Style Guide](../../.claude/resources/workers_styleguide.md)
- [Deployment](../../DEPLOYMENT.md)
- [CLI](../../cli/)
