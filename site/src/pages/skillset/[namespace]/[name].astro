---
import BaseLayout from '@layouts/BaseLayout.astro';
import StarButton from '@components/StarButton';
import DownloadCount from '@components/DownloadCount';
import CopyCommand from '@components/CopyCommand';
import ProofGallery from '@components/ProofGallery.astro';
import { getSkillsetById } from '@/lib/data';
import { sanitizeHtml, sanitizeUrl } from '@/lib/sanitize';
import { marked } from 'marked';
import { gfmHeadingId } from 'marked-gfm-heading-id';

marked.use(gfmHeadingId());

const { namespace, name } = Astro.params;

if (!namespace || !name) {
  return Astro.redirect('/404');
}

const skillsetId = `${namespace}/${name}`;
const skillset = getSkillsetById(skillsetId);

if (!skillset) {
  return Astro.redirect('/404');
}

const authorUrl = sanitizeUrl(skillset.author.url || `https://github.com/${skillset.author.handle.replace('@', '')}`);
const installCommand = `npx skillsets install ${skillsetId}`;

// Fetch README from GitHub at runtime
let readmeHtml = '';
const encodedPath = encodeURIComponent(namespace) + '/' + encodeURIComponent(name);
const readmeUrl = `https://raw.githubusercontent.com/skillsets-cc/main/main/skillsets/${encodedPath}/README.md`;

try {
  const response = await fetch(readmeUrl);
  if (response.ok) {
    let readmeContent = await response.text();
    // Strip the first h1 since we already show the title in the page header
    readmeContent = readmeContent.replace(/^#\s+.+\n+/, '');
    readmeHtml = sanitizeHtml(await marked.parse(readmeContent));
  } else {
    // Fallback to description
    readmeHtml = sanitizeHtml(await marked.parse(skillset.description));
  }
} catch {
  // Fallback to description on network error
  readmeHtml = sanitizeHtml(await marked.parse(skillset.description));
}

// Status indicator color mapping
function getStatusColor(status: string): string {
  switch (status) {
    case 'active':
      return 'bg-green-500';
    case 'deprecated':
      return 'bg-yellow-500';
    default:
      return 'bg-gray-500';
  }
}

const statusColor = getStatusColor(skillset.status);
---

<BaseLayout title={`${skillset.name} - Skillsets.cc`}>
  <article class="max-w-4xl mx-auto px-4 py-12">
    <header class="mb-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h1 class="text-4xl font-bold font-serif mb-2 text-text-ink">{skillset.name}</h1>
          <p class="text-lg text-text-secondary font-serif">
            by <a href={authorUrl} class="text-orange-500 hover:underline" target="_blank" rel="noopener noreferrer">
              {skillset.author.handle}
            </a>
          </p>
        </div>

        <div class="flex items-center gap-2">
          <DownloadCount
            client:load
            skillsetId={skillsetId}
          />
          <StarButton
            client:load
            skillsetId={skillsetId}
            initialStars={skillset.stars}
          />
        </div>
      </div>

      <p class="text-lg text-text-secondary mb-6 font-serif leading-relaxed">{skillset.description}</p>

      <div class="flex flex-wrap gap-2 mb-6">
        {skillset.tags.map((tag) => (
          <span class="px-3 py-1 text-sm font-mono border border-border-ink bg-stone-50 text-text-secondary">
            {tag}
          </span>
        ))}
      </div>

      <div class="flex items-center gap-4 text-sm text-text-tertiary font-mono">
        <span class="flex items-center gap-1">
          v{skillset.version}
        </span>
        <span class="flex items-center gap-1">
          <span class={`w-2 h-2 rounded-full ${statusColor}`}></span>
          {skillset.status}
        </span>
      </div>
    </header>

    <div class="space-y-6">
      <ProofGallery
        productionLinks={skillset.verification.production_links}
        hasAuditReport={!!skillset.verification.audit_report}
        skillsetId={skillsetId}
        contextImageUrl={skillset.context_image_url}
      />

      <section class="p-6 rounded-none">
        <h2 class="text-sm font-bold font-mono mb-4 text-text-ink uppercase tracking-wider border-b border-border-ink pb-2 inline-block">README</h2>
        <article class="prose max-w-none" set:html={readmeHtml} />
      </section>

      <CopyCommand client:load command={installCommand} heading="Install" disclaimer="Submissions are reviewed on a best-effort basis with no security guarantees. You are the final quality gate, as with any OSS." />

      {skillset.mcp_servers && skillset.mcp_servers.length > 0 && (
        <section class="p-6 rounded-none">
          <h2 class="text-sm font-bold font-mono mb-4 text-text-ink uppercase tracking-wider border-b border-border-ink pb-2 inline-block">
            MCP Servers
          </h2>
          <div class="space-y-4">
            {skillset.mcp_servers.filter(s => s.type !== 'docker').length > 0 && (
              <div>
                <h3 class="font-bold font-serif text-text-ink mb-2">Claude Code Managed</h3>
                {skillset.mcp_servers.filter(s => s.type !== 'docker').map(server => (
                  <div class="flex items-start gap-4 mb-3">
                    <div class="w-1 h-full min-h-[40px] bg-orange-500 flex-shrink-0"></div>
                    <div>
                      <p class="font-bold font-serif text-text-ink mb-1">
                        {server.name}
                        <span class="text-text-tertiary font-normal"> ({server.type})</span>
                      </p>
                      {server.command && (
                        <p class="text-sm text-text-secondary font-mono leading-relaxed">
                          {server.command} {(server.args || []).join(' ')}
                        </p>
                      )}
                      {server.url && (
                        <p class="text-sm text-text-secondary font-mono leading-relaxed">{server.url}</p>
                      )}
                      <p class="text-lg text-text-secondary font-serif mt-1 leading-relaxed">
                        {server.mcp_reputation} <span class="italic">(as of {server.researched_at})</span>
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            )}
            {skillset.mcp_servers.filter(s => s.type === 'docker').length > 0 && (
              <div>
                <h3 class="font-bold font-serif text-text-ink mb-2">Docker Hosted</h3>
                {skillset.mcp_servers.filter(s => s.type === 'docker').map(server => (
                  <div class="flex items-start gap-4 mb-3">
                    <div class="w-1 h-full min-h-[40px] bg-orange-500 flex-shrink-0"></div>
                    <div>
                      <p class="font-bold font-mono text-text-ink mb-1">{server.image}</p>
                      <p class="text-lg text-text-secondary font-serif leading-relaxed">
                        {server.mcp_reputation} <span class="italic">(as of {server.researched_at})</span>
                      </p>
                      {server.servers && server.servers.length > 0 && (
                        <p class="text-lg text-text-secondary font-serif mt-1 leading-relaxed">
                          Runs: {server.servers.map(s => s.name).join(', ')}
                        </p>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
          <p class="text-lg text-text-tertiary mt-4 font-serif italic">
            MCP packages are fetched at runtime and may have changed since audit.
          </p>
        </section>
      )}

      <section class="border border-border-ink bg-stone-50 p-6 rounded-none">
        <h2 class="text-sm font-bold font-mono mb-4 text-text-ink uppercase tracking-wider border-b border-border-ink pb-2 inline-block">Compatibility</h2>
        <dl class="space-y-3">
          <div>
            <dt class="text-xs uppercase tracking-wider font-bold text-text-tertiary mb-1">Claude Code Version</dt>
            <dd class="font-mono text-sm text-text-ink">{skillset.compatibility.claude_code_version}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wider font-bold text-text-tertiary mb-1">Languages</dt>
            <dd class="font-mono text-sm text-text-ink">{skillset.compatibility.languages.join(', ')}</dd>
          </div>
        </dl>
      </section>
    </div>

    <div class="mt-8 text-center">
      <a href="/" class="text-orange-500 hover:underline font-serif italic">
        ‚Üê Back to all skillsets
      </a>
    </div>
  </article>
</BaseLayout>
