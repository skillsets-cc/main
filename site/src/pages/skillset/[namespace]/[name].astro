---
import BaseLayout from '@layouts/BaseLayout.astro';
import StarButton from '@components/StarButton';
import DownloadCount from '@components/DownloadCount';
import CopyCommand from '@components/CopyCommand';
import ProofGallery from '@components/ProofGallery.astro';
import MediaGallery from '@components/MediaGallery.astro';
import { getSkillsetById } from '@/lib/data';
import { sanitizeHtml, sanitizeUrl } from '@/lib/sanitize';
import { marked } from 'marked';
import { gfmHeadingId } from 'marked-gfm-heading-id';

marked.use(gfmHeadingId());

const { namespace, name } = Astro.params;

if (!namespace || !name) {
  return Astro.redirect('/404');
}

const skillsetId = `${namespace}/${name}`;
const skillset = getSkillsetById(skillsetId);

if (!skillset) {
  return Astro.redirect('/404');
}

const authorUrl = sanitizeUrl(skillset.author.url || `https://github.com/${skillset.author.handle.replace('@', '')}`);
const installCommand = `npx skillsets install ${skillsetId}`;

// Fetch README from GitHub at runtime
let readmeHtml = '';
const encodedPath = encodeURIComponent(namespace) + '/' + encodeURIComponent(name);
const readmeUrl = `https://raw.githubusercontent.com/skillsets-cc/main/main/skillsets/${encodedPath}/content/README.md`;

try {
  const response = await fetch(readmeUrl);
  if (response.ok) {
    let readmeContent = await response.text();
    // Strip the first h1 since we already show the title in the page header
    readmeContent = readmeContent.replace(/^#\s+.+\n+/, '');
    readmeHtml = sanitizeHtml(await marked.parse(readmeContent));
  } else {
    // Fallback to description
    readmeHtml = sanitizeHtml(await marked.parse(skillset.description));
  }
} catch {
  // Fallback to description on network error
  readmeHtml = sanitizeHtml(await marked.parse(skillset.description));
}

// Status indicator color mapping
function getStatusColor(status: string): string {
  switch (status) {
    case 'active':
      return 'bg-green-500';
    case 'deprecated':
      return 'bg-yellow-500';
    default:
      return 'bg-gray-500';
  }
}

const statusColor = getStatusColor(skillset.status);
---

<BaseLayout title={`${skillset.name} - Skillsets.cc`}>
  <article class="max-w-4xl mx-auto px-4 py-12">
    <div class="sticky top-0 z-50 -mx-4 px-4 pt-6 pb-4 md:pb-10" style="background: white;">
      <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
        <div>
          <h1 class="text-4xl font-bold font-serif mb-2 text-text-ink">{skillset.name}</h1>
          <p class="text-lg text-text-secondary font-serif">
            by <a href={authorUrl} class="text-orange-500 hover:underline" target="_blank" rel="noopener noreferrer">
              {skillset.author.handle}
            </a>
          </p>
        </div>

        <div class="flex items-center gap-2">
          <DownloadCount
            client:load
            skillsetId={skillsetId}
          />
          <StarButton
            client:load
            skillsetId={skillsetId}
            initialStars={skillset.stars}
          />
        </div>
      </div>
    </div>

    <header class="mb-8 mt-4">
      <div class="flex items-center gap-4 text-sm text-text-tertiary font-mono mb-4">
        <span class="flex items-center gap-1">
          v{skillset.version}
        </span>
        <span class="flex items-center gap-1">
          <span class={`w-2 h-2 rounded-full ${statusColor}`}></span>
          {skillset.status}
        </span>
      </div>

      <p class="text-xl text-text-secondary mb-6 font-serif leading-relaxed">{skillset.description}</p>

      <div class="flex flex-wrap gap-2 mb-6">
        {skillset.tags.map((tag) => (
          <span class="px-3 py-1 text-sm font-mono border border-border-ink bg-stone-50 text-text-secondary">
            {tag}
          </span>
        ))}
      </div>
    </header>

    <div class="space-y-6">
      <section class="p-4 rounded-none">
        <div class="flex flex-col gap-2 md:flex-row md:gap-6">
          <h2 class="text-sm font-bold font-mono text-text-ink uppercase tracking-wider whitespace-nowrap md:pt-2">Install</h2>
          <div class="flex-1 min-w-0">
            <CopyCommand client:load command={installCommand} />
            <p class="mt-1.5 text-sm text-text-tertiary font-serif italic">
              Reviewed best-effort with no security guarantees. You are the final quality gate, as with any OSS.
            </p>
          </div>
        </div>
      </section>

      <ProofGallery
        productionLinks={skillset.verification.production_links}
        hasAuditReport={!!skillset.verification.audit_report}
        skillsetId={skillsetId}
      />

      <section class="p-6 rounded-none">
        <h2 class="text-sm font-bold font-mono mb-4 text-text-ink uppercase tracking-wider border-b border-border-ink pb-2 inline-block">README</h2>
        <article class="prose max-w-none" set:html={readmeHtml} />
      </section>

      {skillset.mcp_servers && skillset.mcp_servers.length > 0 && (
        <section class="p-4 rounded-none">
          <div class="flex flex-col gap-2 md:flex-row md:gap-6">
            <h2 class="text-sm font-bold font-mono text-text-ink uppercase tracking-wider whitespace-nowrap">MCP Servers</h2>
            <div class="flex-1 min-w-0">
              <div class="flex flex-wrap gap-x-8 gap-y-2">
                {skillset.mcp_servers.filter(s => s.type !== 'docker').map(server => (
                  <div class="flex items-start gap-2">
                    <div class="w-1 self-stretch bg-orange-500 flex-shrink-0"></div>
                    <div>
                      <p class="font-bold font-serif text-sm text-text-ink">
                        {server.name}
                        <span class="text-text-tertiary font-normal text-xs"> ({server.type})</span>
                      </p>
                      {server.command && (
                        <p class="text-xs text-text-secondary font-mono">
                          {server.command} {(server.args || []).join(' ')}
                        </p>
                      )}
                      {server.url && (
                        <p class="text-xs text-text-secondary font-mono">{server.url}</p>
                      )}
                      <p class="text-xs text-text-secondary font-serif">
                        {server.mcp_reputation} <span class="italic">({server.researched_at})</span>
                      </p>
                    </div>
                  </div>
                ))}
                {skillset.mcp_servers.filter(s => s.type === 'docker').map(server => (
                  <div class="flex items-start gap-2">
                    <div class="w-1 self-stretch bg-orange-500 flex-shrink-0"></div>
                    <div>
                      <p class="font-bold font-mono text-sm text-text-ink">{server.image}</p>
                      <p class="text-xs text-text-secondary font-serif">
                        {server.mcp_reputation} <span class="italic">({server.researched_at})</span>
                      </p>
                      {server.servers && server.servers.length > 0 && (
                        <p class="text-xs text-text-secondary font-serif">
                          Runs: {server.servers.map(s => s.name).join(', ')}
                        </p>
                      )}
                    </div>
                  </div>
                ))}
              </div>
              <p class="text-xs text-text-tertiary mt-2 font-serif italic">
                Packages fetched at runtime and may have changed since audit.
              </p>
            </div>
          </div>
        </section>
      )}

      <section class="border border-border-ink bg-stone-50 p-4 rounded-none">
        <div class="flex flex-col gap-2 md:flex-row md:gap-6">
          <h2 class="text-sm font-bold font-mono text-text-ink uppercase tracking-wider whitespace-nowrap">Compatibility</h2>
          <div class="flex-1 min-w-0 flex flex-wrap gap-x-8 gap-y-1">
            <div>
              <dt class="text-xs uppercase tracking-wider font-bold text-text-tertiary">Claude Code Version</dt>
              <dd class="font-mono text-sm text-text-ink">{skillset.compatibility.claude_code_version}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wider font-bold text-text-tertiary">Languages</dt>
              <dd class="font-mono text-sm text-text-ink">{skillset.compatibility.languages.join(', ')}</dd>
            </div>
          </div>
        </div>
      </section>

      {skillset.context_image_url && (
        <MediaGallery items={[{ url: skillset.context_image_url }]} />
      )}
    </div>

    <div class="mt-8 text-center">
      <a href="/" class="text-orange-500 hover:underline font-serif italic">
        ‚Üê Back to all skillsets
      </a>
    </div>
  </article>

  <script>
    const mermaidBlocks = document.querySelectorAll('pre > code.language-mermaid');
    if (mermaidBlocks.length > 0) {
      const { default: mermaid } = await import('mermaid');
      mermaid.initialize({
        startOnLoad: false,
        theme: 'neutral',
        themeVariables: {
          primaryColor: '#FFF7ED',
          primaryTextColor: '#1A1A1A',
          primaryBorderColor: '#1A1A1A',
          lineColor: '#1A1A1A',
          secondaryColor: '#FFFFFF',
          tertiaryColor: '#F5F5F4',
          background: '#FFFFFF',
          mainBkg: '#FFFFFF',
          nodeBorder: '#1A1A1A',
          clusterBkg: '#FAFAFA',
          clusterBorder: '#1A1A1A',
          titleColor: '#1A1A1A',
          edgeLabelBackground: '#FFFFFF',
          nodeTextColor: '#1A1A1A',
        },
      });

      mermaidBlocks.forEach(code => {
        const pre = code.parentElement!;
        pre.className = 'mermaid not-prose';
        pre.style.textAlign = 'center';
        pre.textContent = code.textContent;
      });

      await mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
    }
  </script>
</BaseLayout>
